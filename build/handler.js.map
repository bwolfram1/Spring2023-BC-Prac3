{"version":3,"file":"handler.js","sources":["../src/handler.js"],"sourcesContent":["import { dirname, exists, fromFileUrl, join } from './deps.ts';\n\nimport { Server } from './server/index.js';\nimport { manifest } from './server/manifest.js';\nimport { env, processEnv } from './env.js';\n\nconst server = new Server(manifest);\nawait server.init({ env: processEnv });\nconst origin = env('ORIGIN', undefined);\nconst xff_depth = parseInt(env('XFF_DEPTH', '1'));\nconst address_header = env('ADDRESS_HEADER', '').toLowerCase();\nconst protocol_header = env('PROTOCOL_HEADER', '').toLowerCase();\nconst host_header = env('HOST_HEADER', 'host').toLowerCase();\nconst body_size_limit = parseInt(env('BODY_SIZE_LIMIT', '524288'));\n\nconst dir = dirname(fromFileUrl(import.meta.url));\n\nasync function serveDirectory(path, client = false) {\n\t// need to use async exists due to existsSync not working on Deno Deploy\n\tif (!(await exists(path))) {\n\t\treturn false;\n\t}\n\treturn (ctx) => {\n\t\tif (client && ctx.request.url.pathname.startsWith(`/${manifest.appDir}/immutable/`)) {\n\t\t\tctx.response.headers.set('cache-control', 'public,max-age=31536000,immutable');\n\t\t}\n\t\treturn ctx.send({ root: path, extensions: ['.html'], index: 'index.html' });\n\t};\n}\n\nasync function ssr(ctx) {\n\tconst request = ctx.request.originalRequest.request;\n\tconst response = await server.respond(request, {\n\t\tgetClientAddress() {\n\t\t\t// TODO: revisit if it doesn't work with proxy\n\t\t\treturn ctx.request.ip;\n\t\t}\n\t});\n\tctx.response.status = response.status;\n\tctx.response.headers = response.headers;\n\tctx.response.body = response.body;\n}\n\nconst handlers = [\n\t...(await Promise.all([\n\t\tserveDirectory(join(dir, 'client'), true),\n\t\tserveDirectory(join(dir, 'prerendered'))\n\t])),\n\tssr\n].filter(Boolean);\n\nexport async function handler(ctx) {\n\tfor (const handle of handlers) {\n\t\ttry {\n\t\t\treturn await handle(ctx);\n\t\t} catch (error) {\n\t\t\t// fall-through to next handler\n\t\t}\n\t}\n\tctx.response.status = 404;\n\tctx.response.body = 'Not found';\n}\n"],"names":[],"mappings":"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"}